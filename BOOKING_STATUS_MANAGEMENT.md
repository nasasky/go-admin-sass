# 房间预订状态自动管理功能

## 功能概述

本系统实现了房间预订订单的状态自动管理功能，可以根据时间自动更新订单状态，确保房间在预约时间内正确被占用，防止重复预订。

## 核心功能

### 1. 自动状态转换

- **已支付 → 使用中**: 当系统时间到达订单开始时间时，自动将订单状态从"已支付"改为"使用中"
- **使用中 → 已完成**: 当系统时间到达订单结束时间时，自动将订单状态从"使用中"改为"已完成"
- **待支付 → 已取消**: 超过24小时未支付的订单自动取消

### 2. 房间状态同步

- 订单开始时：房间状态自动改为"使用中"
- 订单结束时：如果没有其他活跃订单，房间状态自动改为"可用"

### 3. 使用记录管理

- 订单开始时：自动创建使用记录，记录入住时间
- 订单结束时：自动更新使用记录，记录离开时间和实际使用小时数

## API 接口

### 1. 获取订单状态信息

**接口**: `GET /api/admin/bookings/status-info`

**参数**:
```json
{
  "id": 123  // 订单ID
}
```

**响应**:
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "booking_id": 123,
    "booking_no": "BK202312011530001",
    "status": 2,
    "status_text": "已支付",
    "start_time": "2023-12-01T15:30:00Z",
    "end_time": "2023-12-01T18:30:00Z",
    "room_id": 101,
    "room_name": "豪华包厢001",
    "room_status": 1,
    "room_status_text": "可用",
    "current_time": "2023-12-01T15:35:00Z",
    "can_start": true,
    "can_end": false,
    "should_auto_start": true,
    "should_auto_end": false
  }
}
```

### 2. 手动开始订单

**接口**: `POST /api/admin/bookings/manual-start`

**参数**:
```json
{
  "id": 123  // 订单ID
}
```

**说明**: 管理员可以手动将已支付的订单状态改为使用中，适用于提前入住的情况。

### 3. 手动结束订单

**接口**: `POST /api/admin/bookings/manual-end`

**参数**:
```json
{
  "id": 123  // 订单ID
}
```

**说明**: 管理员可以手动将使用中的订单状态改为已完成，适用于提前退房的情况。

## 业务场景

### 场景1：正常预约流程

1. **14:00** - 用户预约15:30-18:30的房间（3小时）
2. **14:00** - 订单状态：待支付
3. **14:30** - 用户支付成功，订单状态：已支付
4. **15:30** - 系统自动将订单状态改为"使用中"，房间状态改为"使用中"
5. **18:30** - 系统自动将订单状态改为"已完成"，房间状态改为"可用"

### 场景2：时间冲突防护

1. **用户A** 预约了15:30-18:30的房间，状态为"已支付"
2. **15:00** - 用户B尝试预约16:00-19:00的同一房间
3. **系统检查** - 发现有重叠时间且状态为"已支付"的订单
4. **返回结果** - "该时间段房间已被预订"

### 场景3：管理员干预

1. **15:20** - 用户提前到达，要求提前入住
2. **管理员操作** - 调用手动开始订单接口
3. **系统处理** - 立即将订单状态改为"使用中"，房间状态改为"使用中"

## 调度器配置

### 启动条件

调度器在以下模式下自动启动：
- `ROUTER_MODE=admin`
- `ROUTER_MODE=all`

### 检查频率

- **定时检查**: 每分钟检查一次
- **处理顺序**: 激活订单 → 完成订单 → 取消超时订单

### 日志记录

系统会记录所有自动状态变更：

```
2023/12/01 15:30:01 订单已激活: BK202312011530001 (房间ID: 101, 用户ID: 1001)
2023/12/01 18:30:01 订单已完成: BK202312011530001 (房间ID: 101, 用户ID: 1001)
2023/12/02 14:30:01 超时订单已取消: BK202312021400001 (用户ID: 1002)
```

## 数据库变更

### 房间使用记录表 (room_usage_logs)

订单状态变更时会自动维护使用记录：

```sql
CREATE TABLE room_usage_logs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    room_id INT NOT NULL,
    booking_id INT NOT NULL,
    user_id INT NOT NULL,
    check_in_at DATETIME,
    check_out_at DATETIME,
    actual_hours DECIMAL(8,2),
    extra_fee DECIMAL(10,2) DEFAULT 0,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

## 状态流转图

```
待支付 ──(支付成功)──→ 已支付 ──(到达开始时间)──→ 使用中 ──(到达结束时间)──→ 已完成
   │                      │                       │
   │                      │                       │
   └──(超时24小时)───→ 已取消     └──(手动结束)──→ 已完成
                          │
                          └──(用户取消)──→ 已取消
```

## 注意事项

1. **时区设置**: 系统使用Asia/Shanghai时区
2. **并发安全**: 使用数据库事务确保状态变更的原子性
3. **错误处理**: 状态变更失败时会记录日志，不影响其他订单处理
4. **性能优化**: 调度器使用单独的goroutine，不影响主服务性能

## 监控和运维

### 健康检查

访问 `/health` 端点可以查看调度器状态：

```json
{
  "service": "nasa-go-admin",
  "mode": "admin",
  "status": "healthy",
  "timestamp": "2023-12-01T15:30:00Z"
}
```

### 日志监控

建议监控以下日志关键词：
- `订单状态自动管理调度器已启动`
- `订单已激活`
- `订单已完成`
- `超时订单已取消`
- `更新订单状态失败`
- `更新房间状态失败`

## MongoDB 日志存储

### 日志记录功能

系统会自动将所有订单状态管理相关的操作记录到MongoDB数据库中，包括：

- **调度器启动日志**: 记录系统启动时间和服务器信息
- **订单状态变更日志**: 记录每次订单状态的自动变更
- **错误日志**: 记录所有操作失败的详细信息
- **管理员操作日志**: 记录管理员的手动干预操作

### 日志查询接口

**获取日志列表**:
```bash
GET /api/admin/bookings/logs?page=1&page_size=20&log_type=booking_activate
```

**获取日志统计**:
```bash
GET /api/admin/bookings/logs/statistics?start_date=2023-12-01&end_date=2023-12-31
```

### 日志数据结构

每条日志记录包含以下信息：
- 日志类型和描述
- 订单和房间信息
- 状态变更前后对比
- 操作详细信息
- 服务器和时间信息
- 错误信息（如有）

详细的API文档请参考 `API_BOOKING_LOG_DOCUMENTATION.md`

## 扩展功能

未来可以考虑添加：

1. **通知功能**: 订单状态变更时发送通知给用户
2. **延期功能**: 允许用户申请延长使用时间
3. **提醒功能**: 在订单即将开始/结束时发送提醒
4. **统计报表**: 分析房间使用率和订单转换率
5. **自定义规则**: 支持不同房间类型的不同处理规则
6. **日志分析**: 基于MongoDB日志数据进行深度分析和报表生成 