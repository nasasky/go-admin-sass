# å®‰å…¨ä¿®å¤å®æ–½æŒ‡å—

## ğŸš¨ ç´§æ€¥å®‰å…¨ä¿®å¤å·²å®Œæˆ

æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨å®‰å…¨åœ°éƒ¨ç½²å·²å®æ–½çš„å®‰å…¨ä¿®å¤æªæ–½ã€‚

## ğŸ“‹ ä¿®å¤å†…å®¹æ¦‚è§ˆ

### âœ… å·²ä¿®å¤çš„å®‰å…¨é—®é¢˜

1. **å¯†ç å“ˆå¸Œç®—æ³•å‡çº§** - MD5 â†’ bcrypt
2. **JWT å®‰å…¨åŠ å¼º** - å¯†é’¥ç®¡ç† + é»‘åå•æœºåˆ¶
3. **SQL æ³¨å…¥é˜²æŠ¤** - è¾“å…¥éªŒè¯ + å‚æ•°åŒ–æŸ¥è¯¢
4. **ä¼šè¯ç®¡ç†å®‰å…¨** - éšæœºå¯†é’¥ + å®‰å…¨é…ç½®

## ğŸ”§ éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆå®‰å…¨å¯†é’¥

```bash
# è¿è¡Œå¯†é’¥ç”Ÿæˆå·¥å…·
go run tools/generate_keys.go

# å°†ç”Ÿæˆçš„å¯†é’¥æ·»åŠ åˆ°ç¯å¢ƒå˜é‡
cp config/security.env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥ç”Ÿæˆçš„å¯†é’¥
```

### ç¬¬äºŒæ­¥ï¼šæ•°æ®åº“è¿ç§»

```bash
# 1. å¤‡ä»½æ•°æ®åº“ï¼ˆé‡è¦ï¼ï¼‰
mysqldump -u username -p database_name > backup_$(date +%Y%m%d_%H%M%S).sql

# 2. æ‰§è¡Œæ•°æ®åº“è¿ç§»
mysql -u username -p database_name < migrations/001_add_password_bcrypt.sql
```

### ç¬¬ä¸‰æ­¥ï¼šæ›´æ–°ä¾èµ–

```bash
# ç¡®ä¿æ‰€æœ‰ä¾èµ–å·²å®‰è£…
go mod tidy
go mod download
```

### ç¬¬å››æ­¥ï¼šæ›´æ–°è·¯ç”±é…ç½®

åœ¨ `router/apiv3.go` ä¸­ï¼Œå°†ç°æœ‰çš„ JWT ä¸­é—´ä»¶æ›¿æ¢ä¸ºå®‰å…¨ç‰ˆæœ¬ï¼š

```go
// æ›¿æ¢åŸæœ‰çš„ä¸­é—´ä»¶
// authGroup.Use(middleware.AdminJWTAuth())
authGroup.Use(middleware.SecureAdminJWTAuth())

// æ·»åŠ æ’¤é”€tokenä¸­é—´ä»¶
authGroup.Use(middleware.RevokeTokenMiddleware())
```

### ç¬¬äº”æ­¥ï¼šæ›´æ–°ä¸»å‡½æ•°

åœ¨ `main.go` ä¸­æ·»åŠ å®‰å…¨ä¼šè¯åˆå§‹åŒ–ï¼š

```go
import "nasa-go-admin/pkg/session"

func main() {
    // ... ç°æœ‰ä»£ç  ...
    
    // åˆå§‹åŒ–å®‰å…¨ä¼šè¯
    redisConfig := config.LoadConfig()
    session.InitSecureSession(app, redisConfig.Addr, redisConfig.Password)
    
    // ... å…¶ä½™ä»£ç  ...
}
```

## ğŸ” éªŒè¯ä¿®å¤æ•ˆæœ

### 1. å¯†ç å®‰å…¨éªŒè¯

```bash
# æµ‹è¯•æ–°ç”¨æˆ·æ³¨å†Œï¼ˆåº”è¯¥ä½¿ç”¨bcryptï¼‰
curl -X POST http://localhost:8801/api/admin/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"TestPass123!","phone":"13800138000"}'

# æ£€æŸ¥æ•°æ®åº“ä¸­çš„å¯†ç å­—æ®µ
mysql> SELECT username, password, password_bcrypt FROM user WHERE username='testuser';
```

### 2. JWT å®‰å…¨éªŒè¯

```bash
# ç™»å½•è·å–token
curl -X POST http://localhost:8801/api/admin/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"TestPass123!"}'

# ä½¿ç”¨tokenè®¿é—®å—ä¿æŠ¤èµ„æº
curl -X GET http://localhost:8801/api/admin/user/info \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"

# é€€å‡ºç™»å½•ï¼ˆtokenåº”è¯¥è¢«åŠ å…¥é»‘åå•ï¼‰
curl -X POST http://localhost:8801/api/admin/logout \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"

# å†æ¬¡ä½¿ç”¨ç›¸åŒtokenï¼ˆåº”è¯¥è¢«æ‹’ç»ï¼‰
curl -X GET http://localhost:8801/api/admin/user/info \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

### 3. SQL æ³¨å…¥é˜²æŠ¤éªŒè¯

```bash
# å°è¯•SQLæ³¨å…¥æ”»å‡»ï¼ˆåº”è¯¥è¢«é˜»æ­¢ï¼‰
curl -X POST http://localhost:8801/api/admin/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin'\'' OR 1=1--","password":"anything"}'
```

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### æ•°æ®è¿ç§»

1. **ç°æœ‰ç”¨æˆ·å¯†ç è¿ç§»**ï¼š
   - ç°æœ‰ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶ä¼šè‡ªåŠ¨å°†MD5å¯†ç å‡çº§ä¸ºbcrypt
   - å»ºè®®é€šçŸ¥ç”¨æˆ·åœ¨é¦–æ¬¡ç™»å½•åé‡æ–°è®¾ç½®å¯†ç 

2. **å¯†ç ç­–ç•¥**ï¼š
   - æ–°å¯†ç å¿…é¡»åŒ…å«ï¼šå¤§å†™å­—æ¯ã€å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦
   - æœ€å°é•¿åº¦8ä½ï¼Œæœ€å¤§é•¿åº¦32ä½

### ç¯å¢ƒé…ç½®

1. **JWT_SIGNING_KEY**ï¼š
   - å¿…é¡»è‡³å°‘32ä¸ªå­—ç¬¦
   - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å¼ºéšæœºå¯†é’¥
   - å®šæœŸæ›´æ¢ï¼ˆå»ºè®®æ¯3-6ä¸ªæœˆï¼‰

2. **Redis é…ç½®**ï¼š
   - ç¡®ä¿RedisæœåŠ¡æ­£å¸¸è¿è¡Œ
   - é…ç½®é€‚å½“çš„å†…å­˜é™åˆ¶
   - å¯ç”¨æŒä¹…åŒ–ï¼ˆå¦‚éœ€è¦ï¼‰

### ç›‘æ§å’Œæ—¥å¿—

1. **å®‰å…¨äº‹ä»¶ç›‘æ§**ï¼š
   - ç›‘æ§å¤±è´¥çš„ç™»å½•å°è¯•
   - ç›‘æ§SQLæ³¨å…¥å°è¯•
   - ç›‘æ§å¼‚å¸¸çš„tokenä½¿ç”¨

2. **æ—¥å¿—è®°å½•**ï¼š
   - è®°å½•æ‰€æœ‰è®¤è¯äº‹ä»¶
   - è®°å½•å®‰å…¨ç­–ç•¥è§¦å‘äº‹ä»¶
   - å®šæœŸå®¡æŸ¥å®‰å…¨æ—¥å¿—

## ğŸ”„ å›æ»šè®¡åˆ’

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤å›æ»šï¼š

1. **åœæ­¢åº”ç”¨æœåŠ¡**
2. **æ¢å¤æ•°æ®åº“å¤‡ä»½**
3. **åˆ‡æ¢å›åŸæœ‰ä»£ç ç‰ˆæœ¬**
4. **é‡å¯æœåŠ¡**

```bash
# æ•°æ®åº“å›æ»š
mysql -u username -p database_name < backup_YYYYMMDD_HHMMSS.sql

# ä»£ç å›æ»š
git checkout previous_commit_hash
```

## ğŸ“Š æ€§èƒ½å½±å“è¯„ä¼°

### bcrypt æ€§èƒ½å½±å“
- CPUä½¿ç”¨ç‡å¯èƒ½å¢åŠ 5-10%
- ç™»å½•å“åº”æ—¶é—´å¢åŠ 50-100ms
- å†…å­˜ä½¿ç”¨åŸºæœ¬æ— å˜åŒ–

### JWT é»‘åå•æ€§èƒ½å½±å“
- RedisæŸ¥è¯¢å¢åŠ ï¼ˆæ¯æ¬¡tokenéªŒè¯ï¼‰
- å“åº”æ—¶é—´å¢åŠ 10-20ms
- å†…å­˜ä½¿ç”¨å¢åŠ ï¼ˆRediså­˜å‚¨ï¼‰

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

1. **å®æ–½å¯†ç ç­–ç•¥**ï¼š
   - å¯†ç è¿‡æœŸç­–ç•¥
   - å¯†ç å†å²è®°å½•
   - è´¦æˆ·é”å®šç­–ç•¥

2. **å¢å¼ºç›‘æ§**ï¼š
   - å®æ—¶å®‰å…¨å‘Šè­¦
   - å¼‚å¸¸è¡Œä¸ºæ£€æµ‹
   - å®‰å…¨æŒ‡æ ‡ä»ªè¡¨æ¿

3. **å®šæœŸå®‰å…¨å®¡è®¡**ï¼š
   - ä»£ç å®‰å…¨æ‰«æ
   - ä¾èµ–æ¼æ´æ£€æŸ¥
   - æ¸—é€æµ‹è¯•

## ğŸ“ æ”¯æŒå’Œå¸®åŠ©

å¦‚æœåœ¨å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ä¸­çš„é”™è¯¯ä¿¡æ¯
2. éªŒè¯ç¯å¢ƒå˜é‡é…ç½®
3. ç¡®è®¤æ•°æ®åº“è¿æ¥æ­£å¸¸
4. æ£€æŸ¥RedisæœåŠ¡çŠ¶æ€

## âœ… éªŒæ”¶æ¸…å•

- [ ] å¯†é’¥å·²ç”Ÿæˆå¹¶é…ç½®
- [ ] æ•°æ®åº“è¿ç§»å·²å®Œæˆ
- [ ] æ–°ç”¨æˆ·æ³¨å†Œä½¿ç”¨bcryptå¯†ç 
- [ ] ç°æœ‰ç”¨æˆ·ç™»å½•è‡ªåŠ¨å‡çº§å¯†ç 
- [ ] JWT tokenåŒ…å«é»‘åå•æœºåˆ¶
- [ ] SQLæ³¨å…¥æ”»å‡»è¢«æˆåŠŸé˜»æ­¢
- [ ] ä¼šè¯é…ç½®ä½¿ç”¨å®‰å…¨å‚æ•°
- [ ] æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡
- [ ] æ€§èƒ½æŒ‡æ ‡åœ¨å¯æ¥å—èŒƒå›´å†…
- [ ] ç›‘æ§å’Œå‘Šè­¦æ­£å¸¸å·¥ä½œ

å®Œæˆä»¥ä¸Šæ‰€æœ‰æ­¥éª¤åï¼Œæ‚¨çš„ç³»ç»Ÿå®‰å…¨æ€§å°†å¾—åˆ°æ˜¾è‘—æå‡ï¼ 